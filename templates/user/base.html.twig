{% extends 'base.html.twig' %}

{% from _self import timestamp %}

{% block sidebar_top_classes 'card' %}
{% block sidebar_top %}
  {% from 'user/_macros.html.twig' import user_flag %}
  <section class="container pad vp vp--guttered vertical-pad">
    <div class="nav nav--guttered nav--align-end">
      <div class="break-text ellipsify">
        <h4 class="inline no-margin">
          <a href="{{ path('user', {username: user.username}) }}"><small>/u/</small>{{ user.username }}</a>
        </h4>

        {{ user.admin ? user_flag('admin', {full_label: true}) }}
      </div>

      <p class="no-margin">
        <small class="dimmed">{{ 'user.registered'|trans({'%timestamp%': timestamp(user.created)})|raw }}</small>
      </p>
    </div>

    {% if user.biography is not empty %}
      <div class="hide-empty">
        {{ user.biography|cached_markdown(markdown_context())|raw }}
      </div>
    {% endif %}

    <div class="nav nav--guttered hide-empty">
      {%- if user is same as(app.user) or is_granted('ROLE_ADMIN') -%}
        <a href="{{ path('edit_biography', {username: user.username}) }}"
           class="button button--inline button--secondary block">
          {{- 'nav.edit_biography'|trans -}}
        </a>
      {%- endif -%}

      {%- if is_granted('ROLE_USER') and user is not same as(app.user) -%}
        {% if not app.user.isBlocking(user) %}
          <a href="{{ path('block_user', {username: user.username}) }}"
             class="button button--inline button--secondary block">
            {{ 'nav.block_user'|trans }}
          </a>
        {% else %}
          <form action="{{ path('unblock_user', {username: user.username}) }}" method="POST">
            <input type="hidden" name="token" value="{{ csrf_token('unblock') }}">
            <button class="button button--inline block">{{ 'action.unblock'|trans }}</button>
          </form>
        {% endif %}
      {%- endif -%}
    </div>
  </section>
{% endblock sidebar_top %}

{% set toolbox_items = {
  ('user.message'|trans): { route: 'compose_message', params: {username: user.username}, condition: is_granted('ROLE_USER') and is_granted('message', user) },
  ('action.ban'|trans): { route: 'ban_user', params: {username: user.username}, condition: is_granted('ROLE_ADMIN') and not user.banned },
  ('action.unban'|trans): { route: 'unban_user', params: {username: user.username}, condition: is_granted('ROLE_ADMIN') and user.banned },
  ('nav.forum_bans'|trans): { route: 'user_forum_bans', params: {username: user.username}, condition: is_granted('ROLE_ADMIN') },
  ('nav.my_account'|trans): { route: 'edit_user', params: {username: user.username}, condition: user is same as(app.user) or is_granted('ROLE_ADMIN') },
  ('nav.user_settings'|trans): { route: 'user_settings', params: {username: user.username}, condition: user is same as(app.user) or is_granted('ROLE_ADMIN') },
} %}

{% block sidebar_bottom_classes 'container vp vp--guttered' %}
{% block sidebar_bottom %}
  {% if toolbox_items is not empty %}
    <section class="card">
      <h4 class="no-margin pad vertical-pad">{{ 'label.toolbox'|trans }}</h4>
      <ul class="unlistify">
        {% for key in toolbox_items|keys|sort if toolbox_items[key].condition ?? true %}
          <li>
            <a href="{{ path(toolbox_items[key].route, toolbox_items[key].params ?? {}) }}"
               class="menu-link {{ app.request.attributes.get('_route') == toolbox_items[key].route ? 'menu-link--active' }}">
              {{- key -}}
            </a>
          </li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}

  {% if is_granted('ROLE_ADMIN') %}
    <section class="card pad vertical-pad">
      <h4>{{ 'heading.user_roles'|trans }}</h4>
      <form action="{{ path('mark_user_trusted', {id: user.id, trusted: not user.trusted ? 1 : 0}) }}" method="post" class="form">
        <input type="hidden" name="token" value="{{ csrf_token('mark_trusted') }}">
        <div class="form__row">
          <button class="button">{{ (not user.trusted ? 'action.mark_as_trusted' : 'action.mark_as_untrusted')|trans }}</button>
        </div>
      </form>
    </section>
  {% endif %}

  {% if user.moderatorTokens is not empty %}
    <section class="card">
      <h4 class="no-margin pad vertical-pad">{{ 'user.moderates'|trans({'%username%': user.username}) }}</h4>
      <ul class="unlistify">
        {% for token in user.moderatorTokens %}
          <li><a href="{{ path('forum', {forum_name: token.forum.name}) }}" class="menu-link">{{ token.forum.name }}</a></li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}
{% endblock %}

{%- macro timestamp(timestamp) -%}
  {%- set date = timestamp|localizeddate('long', 'short') -%}
  <time datetime="{{ timestamp|date('c') }}" class="relative-time" title="{{ date }}">
    {{- 'time.on_timestamp'|trans({'%timestamp%': date}) -}}
  </time>
{%- endmacro -%}
